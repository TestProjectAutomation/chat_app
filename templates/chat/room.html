{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{{ room.name }} - DeepChat{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
    }
    
    .messages-container {
        height: calc(100% - 120px);
    }
    
    .message-bubble {
        max-width: 70%;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message-bubble.sent {
        background-color: #3b82f6;
        color: white;
        border-bottom-right-radius: 4px;
        margin-left: auto;
    }
    
    .message-bubble.received {
        background-color: #e5e7eb;
        color: #374151;
        border-bottom-left-radius: 4px;
        margin-right: auto;
    }
    
    .dark .message-bubble.received {
        background-color: #4b5563;
        color: #f9fafb;
    }
    
    .online-dot {
        width: 10px;
        height: 10px;
        background-color: #10b981;
        border-radius: 50%;
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Room Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">{{ room.name }}</h2>
                {% if room.description %}
                <p class="text-gray-600 dark:text-gray-300 mt-1">{{ room.description }}</p>
                {% endif %}
                <div class="flex items-center mt-2 space-x-2 rtl:space-x-reverse">
                    <span class="text-sm text-gray-500 dark:text-gray-400">
                        <i class="fas fa-users mr-1"></i>
                        {{ room.participants.count }} {% trans "participants" %}
                    </span>
                    {% if room.is_private %}
                    <span class="text-sm text-gray-500 dark:text-gray-400">
                        <i class="fas fa-lock mr-1"></i>
                        {% trans "Private" %}
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="flex space-x-2 rtl:space-x-reverse">
                <button id="room-info-btn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fas fa-info-circle"></i>
                </button>
                <a href="{% url 'chat:index' %}" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fas fa-times"></i>
                </a>
            </div>
        </div>
    </div>
    
    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Chat Area -->
        <div class="lg:w-2/3">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden chat-container">
                <!-- Messages Container -->
                <div id="messages-container" class="messages-container p-4 overflow-y-auto custom-scrollbar">
                    {% for message in messages %}
                    <div class="mb-4 message-fade-in {% if message.sender == user %}text-right{% endif %}">
                        {% if message.parent_message %}
                        <div class="mb-1 text-xs text-gray-500 dark:text-gray-400 pl-4 border-l-2 border-gray-300 dark:border-gray-600">
                            <i class="fas fa-reply mr-1"></i>
                            {% trans "Reply to" %} {{ message.parent_message.sender.username }}:
                            <span class="italic">{{ message.parent_message.content|truncatechars:50 }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="flex {% if message.sender == user %}justify-end{% endif %} items-start space-x-2 rtl:space-x-reverse">
                            {% if message.sender != user %}
                            <div class="flex-shrink-0">
                                {% if message.sender.profile.avatar %}
                                <img src="{{ message.sender.profile.avatar.url }}" 
                                     alt="{{ message.sender.username }}"
                                     class="w-8 h-8 rounded-full">
                                {% else %}
                                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center">
                                    {{ message.sender.username|first|upper }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <div class="message-bubble {% if message.sender == user %}sent{% else %}received{% endif %} p-3">
                                {% if message.sender != user %}
                                <div class="font-semibold text-sm mb-1 {% if message.sender == user %}text-blue-100{% else %}text-gray-600 dark:text-gray-300{% endif %}">
                                    {{ message.sender.username }}
                                </div>
                                {% endif %}
                                <div class="{% if message.sender == user %}text-white{% endif %}">
                                    {{ message.content|linebreaks }}
                                </div>
                                <div class="text-xs mt-1 {% if message.sender == user %}text-blue-200{% else %}text-gray-500 dark:text-gray-400{% endif %}">
                                    {{ message.timestamp|time }}
                                    {% if message.is_read and message.sender == user %}
                                    <i class="fas fa-check-double ml-1"></i>
                                    {% elif message.sender == user %}
                                    <i class="fas fa-check ml-1"></i>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if message.sender == user %}
                            <div class="flex-shrink-0">
                                {% if user.profile.avatar %}
                                <img src="{{ user.profile.avatar.url }}" 
                                     alt="{{ user.username }}"
                                     class="w-8 h-8 rounded-full">
                                {% else %}
                                <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center">
                                    {{ user.username|first|upper }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="h-full flex items-center justify-center text-gray-500 dark:text-gray-400">
                        <div class="text-center">
                            <i class="fas fa-comments text-4xl mb-4"></i>
                            <p class="text-lg">{% trans "No messages yet. Start the conversation!" %}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Typing Indicator -->
                <div id="typing-indicator" class="hidden px-4 py-2 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center space-x-2 rtl:space-x-reverse">
                        <div class="typing-dot bg-gray-400 dark:bg-gray-500 w-2 h-2 rounded-full"></div>
                        <div class="typing-dot bg-gray-400 dark:bg-gray-500 w-2 h-2 rounded-full"></div>
                        <div class="typing-dot bg-gray-400 dark:bg-gray-500 w-2 h-2 rounded-full"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400" id="typing-text"></span>
                    </div>
                </div>
                
                <!-- Message Input -->
                <div class="border-t border-gray-200 dark:border-gray-700 p-4">
                    <form id="message-form" class="flex space-x-2 rtl:space-x-reverse">
                        {% csrf_token %}
                        <div class="flex-grow">
                            <textarea id="message-input" 
                                      rows="1"
                                      placeholder="{% trans 'Type your message here...' %}"
                                      class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600"></textarea>
                        </div>
                        <button type="submit"
                                class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <i class="fas fa-paper-plane"></i>
                            <span class="sr-only">{% trans "Send" %}</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="lg:w-1/3">
            <!-- Participants -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 mb-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">
                    <i class="fas fa-users mr-2"></i>{% trans "Participants" %}
                </h3>
                <div class="space-y-3">
                    {% for participant in room.participants.all %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 rtl:space-x-reverse">
                            {% if participant.profile.avatar %}
                            <img src="{{ participant.profile.avatar.url }}" 
                                 alt="{{ participant.username }}"
                                 class="w-10 h-10 rounded-full object-cover">
                            {% else %}
                            <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center">
                                {{ participant.username|first|upper }}
                            </div>
                            {% endif %}
                            <div>
                                <div class="font-medium text-gray-800 dark:text-white">
                                    {{ participant.username }}
                                    {% if participant == room.creator %}
                                    <span class="text-xs bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100 px-2 py-1 rounded ml-2">
                                        {% trans "Creator" %}
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 flex items-center">
                                    {% if participant.profile.online_status %}
                                    <span class="online-dot mr-1"></span>
                                    {% trans "Online" %}
                                    {% else %}
                                    <span class="text-xs">{% trans "Last seen" %} {{ participant.profile.last_seen|timesince }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% if participant != user %}
                        <button class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Room Info -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">
                    <i class="fas fa-info-circle mr-2"></i>{% trans "Room Information" %}
                </h3>
                <div class="space-y-3">
                    <div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">{% trans "Created by" %}</div>
                        <div class="font-medium text-gray-800 dark:text-white">{{ room.creator.username }}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">{% trans "Created on" %}</div>
                        <div class="font-medium text-gray-800 dark:text-white">{{ room.created_at|date:"F j, Y" }}</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">{% trans "Last activity" %}</div>
                        <div class="font-medium text-gray-800 dark:text-white">{{ room.updated_at|timesince }} {% trans "ago" %}</div>
                    </div>
                </div>
                
                {% if user == room.creator %}
                <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button class="w-full px-4 py-2 bg-red-100 text-red-700 dark:bg-red-800 dark:text-red-100 rounded-lg hover:bg-red-200 dark:hover:bg-red-700">
                        <i class="fas fa-trash mr-2"></i>{% trans "Delete Room" %}
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const roomId = "{{ room.id }}";
    const currentUser = "{{ user.username }}";
    const currentUserId = "{{ user.id }}";
    
    // WebSocket Connection
    const chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomId + '/'
    );
    
    // Message Form Submission
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('messages-container');
    
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        
        if (message) {
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'content': message
            }));
            messageInput.value = '';
            autoResizeTextarea();
        }
    });
    
    // Auto-resize textarea
    function autoResizeTextarea() {
        messageInput.style.height = 'auto';
        messageInput.style.height = (messageInput.scrollHeight) + 'px';
        if (parseInt(messageInput.style.height) > 120) {
            messageInput.style.height = '120px';
            messageInput.style.overflowY = 'auto';
        } else {
            messageInput.style.overflowY = 'hidden';
        }
    }
    
    messageInput.addEventListener('input', autoResizeTextarea);
    
    // Typing Indicator
    let typingTimeout;
    messageInput.addEventListener('input', function() {
        chatSocket.send(JSON.stringify({
            'type': 'typing',
            'is_typing': true
        }));
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            chatSocket.send(JSON.stringify({
                'type': 'typing',
                'is_typing': false
            }));
        }, 1000);
    });
    
    // Handle incoming WebSocket messages
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        switch(data.type) {
            case 'chat_message':
                addMessage(data);
                break;
                
            case 'user_join':
                showSystemMessage(`${data.username} joined the chat`);
                break;
                
            case 'user_leave':
                showSystemMessage(`${data.username} left the chat`);
                break;
                
            case 'typing':
                showTypingIndicator(data);
                break;
        }
    };
    
    // Add message to chat
    function addMessage(data) {
        const isCurrentUser = data.sender_username === currentUser;
        const messageElement = document.createElement('div');
        messageElement.className = `mb-4 message-fade-in ${isCurrentUser ? 'text-right' : ''}`;
        
        messageElement.innerHTML = `
            <div class="flex ${isCurrentUser ? 'justify-end' : ''} items-start space-x-2 rtl:space-x-reverse">
                ${!isCurrentUser ? `
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center">
                        ${data.sender_username.charAt(0).toUpperCase()}
                    </div>
                </div>
                ` : ''}
                
                <div class="message-bubble ${isCurrentUser ? 'sent' : 'received'} p-3">
                    ${!isCurrentUser ? `
                    <div class="font-semibold text-sm mb-1 ${isCurrentUser ? 'text-blue-100' : 'text-gray-600 dark:text-gray-300'}">
                        ${data.sender_username}
                    </div>
                    ` : ''}
                    <div class="${isCurrentUser ? 'text-white' : ''}">
                        ${data.content.replace(/\n/g, '<br>')}
                    </div>
                    <div class="text-xs mt-1 ${isCurrentUser ? 'text-blue-200' : 'text-gray-500 dark:text-gray-400'}">
                        ${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        ${isCurrentUser ? '<i class="fas fa-check-double ml-1"></i>' : ''}
                    </div>
                </div>
                
                ${isCurrentUser ? `
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center">
                        ${currentUser.charAt(0).toUpperCase()}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
        
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Show system message
    function showSystemMessage(text) {
        const systemMessage = document.createElement('div');
        systemMessage.className = 'text-center my-2';
        systemMessage.innerHTML = `
            <span class="inline-block px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-sm rounded-full">
                ${text}
            </span>
        `;
        messagesContainer.appendChild(systemMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Show typing indicator
    let typingUsers = {};
    function showTypingIndicator(data) {
        const typingIndicator = document.getElementById('typing-indicator');
        const typingText = document.getElementById('typing-text');
        
        if (data.is_typing && data.username !== currentUser) {
            typingUsers[data.username] = true;
        } else {
            delete typingUsers[data.username];
        }
        
        const typingUserList = Object.keys(typingUsers);
        if (typingUserList.length > 0) {
            typingIndicator.classList.remove('hidden');
            if (typingUserList.length === 1) {
                typingText.textContent = `${typingUserList[0]} is typing...`;
            } else if (typingUserList.length === 2) {
                typingText.textContent = `${typingUserList.join(' and ')} are typing...`;
            } else {
                typingText.textContent = `${typingUserList.length} people are typing...`;
            }
        } else {
            typingIndicator.classList.add('hidden');
        }
    }
    
    // Handle WebSocket connection close
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        setTimeout(function() {
            connectWebSocket();
        }, 1000);
    };
    
    // Initial scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
</script>
{% endblock %}